using System;
using Modm.Extensions;

namespace Modm.Tests.UnitTests
{
	public class StringExtensionsTests
	{
        [Fact]
        public async Task logs_should_strip_after_marker()
        {
            string marker = "-----------------";
            string diagnosticsLogs = "Started by user admin\nRunning as SYSTEM\nBuilding in workspace /var/jenkins_home/workspace/arm\n[WS-CLEANUP] Deleting project workspace...\n[WS-CLEANUP] Deferred wipeout is used...\n[arm] $ /bin/sh -xe /tmp/jenkins16804429162017114843.sh\n+ /var/jenkins_home/modm/source/jenkins/definitions/arm/deploy.sh\n[\n  {\n    \"environmentName\": \"AzureCloud\",\n    \"homeTenantId\": \"5e3992bd-1b0a-43cf-b87a-a1aaacbf0be2\",\n    \"id\": \"31e9f9a0-9fd2-4294-a0a3-0101246d9700\",\n    \"isDefault\": true,\n    \"managedByTenants\": [\n      {\n        \"tenantId\": \"72f988bf-86f1-41af-91ab-2d7cd011db47\"\n      }\n    ],\n    \"name\": \"Code-With-MngEnvMCAP527357\",\n    \"state\": \"Enabled\",\n    \"tenantId\": \"5e3992bd-1b0a-43cf-b87a-a1aaacbf0be2\",\n    \"user\": {\n      \"assignedIdentityInfo\": \"MSI\",\n      \"name\": \"systemAssignedIdentity\",\n      \"type\": \"servicePrincipal\"\n    }\n  }\n]\n-----------------\n{\n  \"id\": \"/subscriptions/31e9f9a0-9fd2-4294-a0a3-0101246d9700/resourceGroups/rg-181-20231127000015/providers/Microsoft.Resources/deployments/deployment1\",\n  \"location\": null,\n  \"name\": \"deployment1\",\n  \"properties\": {\n    \"correlationId\": \"6a96b652-955b-40a7-8027-024257f5c423\",\n    \"debugSetting\": null,\n    \"dependencies\": [],\n    \"duration\": \"PT32.2456095S\",\n    \"error\": null,\n    \"mode\": \"Incremental\",\n    \"onErrorDeployment\": null,\n    \"outputResources\": [\n      {\n        \"id\": \"/subscriptions/31e9f9a0-9fd2-4294-a0a3-0101246d9700/resourceGroups/rg-181-20231127000015/providers/Microsoft.Storage/storageAccounts/sa3ejun4pagcol4\",\n        \"resourceGroup\": \"rg-181-20231127000015\"\n      }\n    ],\n    \"outputs\": {\n      \"storageAccountId\": {\n        \"type\": \"String\",\n        \"value\": \"/subscriptions/31e9f9a0-9fd2-4294-a0a3-0101246d9700/resourceGroups/rg-181-20231127000015/providers/Microsoft.Storage/storageAccounts/sa3ejun4pagcol4\"\n      }\n    },\n    \"parameters\": {\n      \"location\": {\n        \"type\": \"String\",\n        \"value\": \"eastus\"\n      },\n      \"resourceGroupName\": {\n        \"type\": \"String\",\n        \"value\": \"rg-181-20231127000015\"\n      }\n    },\n    \"parametersLink\": null,\n    \"providers\": [\n      {\n        \"id\": null,\n        \"namespace\": \"Microsoft.Resources\",\n        \"providerAuthorizationConsentState\": null,\n        \"registrationPolicy\": null,\n        \"registrationState\": null,\n        \"resourceTypes\": [\n          {\n            \"aliases\": null,\n            \"apiProfiles\": null,\n            \"apiVersions\": null,\n            \"capabilities\": null,\n            \"defaultApiVersion\": null,\n            \"locationMappings\": null,\n            \"locations\": [\n              null\n            ],\n            \"properties\": null,\n            \"resourceType\": \"deployments\",\n            \"zoneMappings\": null\n          }\n        ]\n      }\n    ],\n    \"provisioningState\": \"Succeeded\",\n    \"templateHash\": \"18187652096248549133\",\n    \"templateLink\": null,\n    \"timestamp\": \"2023-11-27T05:08:12.006307+00:00\",\n    \"validatedResources\": null\n  },\n  \"resourceGroup\": \"rg-181-20231127000015\",\n  \"tags\": null,\n  \"type\": \"Microsoft.Resources/deployments\"\n}\nFinished: SUCCESS";
            string expectedContent = "\n{\n  \"id\": \"/subscriptions/31e9f9a0-9fd2-4294-a0a3-0101246d9700/resourceGroups/rg-181-20231127000015/providers/Microsoft.Resources/deployments/deployment1\",\n  \"location\": null,\n  \"name\": \"deployment1\",\n  \"properties\": {\n    \"correlationId\": \"6a96b652-955b-40a7-8027-024257f5c423\",\n    \"debugSetting\": null,\n    \"dependencies\": [],\n    \"duration\": \"PT32.2456095S\",\n    \"error\": null,\n    \"mode\": \"Incremental\",\n    \"onErrorDeployment\": null,\n    \"outputResources\": [\n      {\n        \"id\": \"/subscriptions/31e9f9a0-9fd2-4294-a0a3-0101246d9700/resourceGroups/rg-181-20231127000015/providers/Microsoft.Storage/storageAccounts/sa3ejun4pagcol4\",\n        \"resourceGroup\": \"rg-181-20231127000015\"\n      }\n    ],\n    \"outputs\": {\n      \"storageAccountId\": {\n        \"type\": \"String\",\n        \"value\": \"/subscriptions/31e9f9a0-9fd2-4294-a0a3-0101246d9700/resourceGroups/rg-181-20231127000015/providers/Microsoft.Storage/storageAccounts/sa3ejun4pagcol4\"\n      }\n    },\n    \"parameters\": {\n      \"location\": {\n        \"type\": \"String\",\n        \"value\": \"eastus\"\n      },\n      \"resourceGroupName\": {\n        \"type\": \"String\",\n        \"value\": \"rg-181-20231127000015\"\n      }\n    },\n    \"parametersLink\": null,\n    \"providers\": [\n      {\n        \"id\": null,\n        \"namespace\": \"Microsoft.Resources\",\n        \"providerAuthorizationConsentState\": null,\n        \"registrationPolicy\": null,\n        \"registrationState\": null,\n        \"resourceTypes\": [\n          {\n            \"aliases\": null,\n            \"apiProfiles\": null,\n            \"apiVersions\": null,\n            \"capabilities\": null,\n            \"defaultApiVersion\": null,\n            \"locationMappings\": null,\n            \"locations\": [\n              null\n            ],\n            \"properties\": null,\n            \"resourceType\": \"deployments\",\n            \"zoneMappings\": null\n          }\n        ]\n      }\n    ],\n    \"provisioningState\": \"Succeeded\",\n    \"templateHash\": \"18187652096248549133\",\n    \"templateLink\": null,\n    \"timestamp\": \"2023-11-27T05:08:12.006307+00:00\",\n    \"validatedResources\": null\n  },\n  \"resourceGroup\": \"rg-181-20231127000015\",\n  \"tags\": null,\n  \"type\": \"Microsoft.Resources/deployments\"\n}\nFinished: SUCCESS";

            string strippedContent = diagnosticsLogs.SubstringAfterMarker(marker).Replace("jenkins", "***");

            Assert.Equal(expectedContent, strippedContent);
        }
    }
}

